name: Smart Release Manager

on:
  # Trigger when pyproject.toml changes on main
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'
  
  # Manual trigger with release notes
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - current
        default: 'current'
      
      release_notes:
        description: 'Release notes (what changed)'
        required: true
        type: string
        default: |
          ### Added
          - New features here
          
          ### Fixed
          - Bug fixes here
          
          ### Changed
          - Changes here
      
      create_release:
        description: 'Create GitHub release?'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  detect-version-change:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.changed }}
      old_version: ${{ steps.check.outputs.old_version }}
      new_version: ${{ steps.check.outputs.new_version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check if version changed
      id: check
      run: |
        # Get current version
        NEW_VERSION=$(grep -m1 'version = ' pyproject.toml | cut -d'"' -f2)
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # Get previous version
        git checkout HEAD~1 pyproject.toml 2>/dev/null || echo "First commit"
        OLD_VERSION=$(grep -m1 'version = ' pyproject.toml | cut -d'"' -f2 2>/dev/null || echo "0.0.0")
        echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
        
        # Check if changed
        if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Version changed: $OLD_VERSION -> $NEW_VERSION"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "Version unchanged: $NEW_VERSION"
        fi

  calculate-version:
    name: Calculate New Version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      new_version: ${{ steps.calc.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Calculate version
      id: calc
      run: |
        CURRENT=$(grep -m1 'version = ' pyproject.toml | cut -d'"' -f2)
        RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        
        if [ "$RELEASE_TYPE" == "current" ]; then
          NEW_VERSION="$CURRENT"
        else
          IFS='.' read -ra PARTS <<< "$CURRENT"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}
          
          case $RELEASE_TYPE in
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
          esac
        fi
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Version will be: $NEW_VERSION"

  update-version:
    name: Update Version Files
    needs: calculate-version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.release_type != 'current'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Update version in files
      run: |
        NEW_VERSION="${{ needs.calculate-version.outputs.new_version }}"
        
        # Update pyproject.toml
        sed -i "s/version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml
        
        # Update __init__.py files if they exist
        if [ -f "__init__.py" ]; then
          sed -i "s/__version__ = \".*\"/__version__ = \"$NEW_VERSION\"/" __init__.py
        fi
        if [ -f "viincci_rag/__init__.py" ]; then
          sed -i "s/__version__ = \".*\"/__version__ = \"$NEW_VERSION\"/" viincci_rag/__init__.py
        fi
        
        echo "Updated version to $NEW_VERSION"
    
    - name: Update CHANGELOG
      run: |
        NEW_VERSION="${{ needs.calculate-version.outputs.new_version }}"
        DATE=$(date +%Y-%m-%d)
        
        # Save release notes to temp file
        cat > release_notes_temp.txt << 'EOF'
        ${{ github.event.inputs.release_notes }}
        EOF
        
        # Create changelog entry
        {
          echo "## [$NEW_VERSION] - $DATE"
          echo ""
          cat release_notes_temp.txt
          echo ""
          echo ""
        } > new_entry.txt
        
        # Insert into CHANGELOG.md
        if [ -f "CHANGELOG.md" ]; then
          # Backup original
          cp CHANGELOG.md CHANGELOG.md.bak
          # Insert new entry after the first line (header)
          head -n 1 CHANGELOG.md > temp_changelog.md
          echo "" >> temp_changelog.md
          cat new_entry.txt >> temp_changelog.md
          tail -n +2 CHANGELOG.md.bak >> temp_changelog.md
          mv temp_changelog.md CHANGELOG.md
          rm CHANGELOG.md.bak
        else
          # Create new CHANGELOG
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          cat new_entry.txt >> CHANGELOG.md
        fi
        
        rm -f new_entry.txt release_notes_temp.txt
        echo "Updated CHANGELOG.md"
    
    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Add files
        git add pyproject.toml CHANGELOG.md
        
        # Add __init__.py files if they exist
        if [ -f "__init__.py" ]; then
          git add __init__.py
        fi
        if [ -f "viincci_rag/__init__.py" ]; then
          git add viincci_rag/__init__.py
        fi
        
        # Commit and push
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: bump version to ${{ needs.calculate-version.outputs.new_version }}"
          git push
          echo "Changes committed and pushed"
        fi

  create-release:
    name: Create GitHub Release
    needs: [detect-version-change, calculate-version, update-version]
    runs-on: ubuntu-latest
    if: |
      always() && 
      !cancelled() &&
      (
        (github.event_name == 'push' && needs.detect-version-change.outputs.version_changed == 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      )
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ needs.calculate-version.outputs.new_version }}"
        else
          VERSION="${{ needs.detect-version-change.outputs.new_version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Creating release for version: $VERSION"
    
    - name: Extract changelog
      id: changelog
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        if [ -f "CHANGELOG.md" ]; then
          # Extract this version's changelog section
          awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | head -n -1 | tail -n +2 > release_notes.txt
          
          # Check if we got any content
          if [ ! -s release_notes.txt ]; then
            echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." > release_notes.txt
          fi
        else
          # Use manual release notes if no CHANGELOG exists
          cat > release_notes.txt << 'EOF'
        ${{ github.event.inputs.release_notes }}
        EOF
        fi
        
        echo "Release notes prepared"
    
    - name: Create git tag
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if tag already exists
        if git rev-parse "v$VERSION" >/dev/null 2>&1; then
          echo "Tag v$VERSION already exists, skipping tag creation"
        else
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION"
          echo "Created and pushed tag v$VERSION"
        fi
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: v${{ steps.version.outputs.version }}
        body_path: release_notes.txt
        draft: false
        prerelease: false
        generate_release_notes: true

  summary:
    name: Release Summary
    needs: [detect-version-change, calculate-version, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ needs.calculate-version.outputs.new_version }}"
          echo "**Triggered by:** Manual dispatch" >> $GITHUB_STEP_SUMMARY
          echo "**Release type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
        else
          VERSION="${{ needs.detect-version-change.outputs.new_version }}"
          echo "**Triggered by:** Version change in pyproject.toml" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Job Status" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Detect Version | ${{ needs.detect-version-change.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Calculate Version | ${{ needs.calculate-version.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Create Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Release v$VERSION](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
        echo "- [All Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
        echo "- [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
